name: Snowflake CI/CD Deployment

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Snowflake Connector
        run: pip install snowflake-connector-python

      - name: Deploy SQL Scripts
        env:
          # DEV Secrets
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

          # PROD Secrets
          SNOWFLAKE_ACCOUNT_PROD: ${{ secrets.SNOWFLAKE_ACCOUNT_PROD }}
          SNOWFLAKE_USER_PROD: ${{ secrets.SNOWFLAKE_USER_PROD }}
          SNOWFLAKE_PASSWORD_PROD: ${{ secrets.SNOWFLAKE_PASSWORD_PROD }}
          SNOWFLAKE_ROLE_PROD: ${{ secrets.SNOWFLAKE_ROLE_PROD }}
          SNOWFLAKE_WAREHOUSE_PROD: ${{ secrets.SNOWFLAKE_WAREHOUSE_PROD }}
          SNOWFLAKE_DATABASE_PROD: ${{ secrets.SNOWFLAKE_DATABASE_PROD }}
          SNOWFLAKE_SCHEMA_PROD: ${{ secrets.SNOWFLAKE_SCHEMA_PROD }}

        run: |
          python <<EOF
          import os
          import snowflake.connector
          from pathlib import Path

          branch = os.getenv("GITHUB_REF_NAME")
          print("Branch:", branch)

          # Choose environment based on branch
          if branch == "main":
              print("Deploying to PROD...")
              account = os.environ["SNOWFLAKE_ACCOUNT_PROD"]
              user = os.environ["SNOWFLAKE_USER_PROD"]
              password = os.environ["SNOWFLAKE_PASSWORD_PROD"]
              role = os.environ["SNOWFLAKE_ROLE_PROD"]
              warehouse = os.environ["SNOWFLAKE_WAREHOUSE_PROD"]
              database = os.environ["SNOWFLAKE_DATABASE_PROD"]
              schema = os.environ["SNOWFLAKE_SCHEMA_PROD"]

          else:
              print("Deploying to DEV...")
              account = os.environ["SNOWFLAKE_ACCOUNT"]
              user = os.environ["SNOWFLAKE_USER"]
              password = os.environ["SNOWFLAKE_PASSWORD"]
              role = os.environ["SNOWFLAKE_ROLE"]
              warehouse = os.environ["SNOWFLAKE_WAREHOUSE"]
              database = os.environ["SNOWFLAKE_DATABASE"]
              schema = os.environ["SNOWFLAKE_SCHEMA"]

          # Read SQL files
          sql_files = sorted(Path("sql").glob("*.sql"))

          if not sql_files:
              raise Exception("❌ No SQL files found inside sql/ folder!")

          print("SQL files found:", sql_files)

          # Connect to Snowflake
          conn = snowflake.connector.connect(
              user=user,
              password=password,
              account=account,
              role=role,
              warehouse=warehouse
          )

          cursor = conn.cursor()

          try:
              # Set database and schema
              cursor.execute(f"USE DATABASE {database}")
              cursor.execute(f"USE SCHEMA {schema}")

              # Execute each SQL file
              for file in sql_files:
                  print(f"Executing: {file}")
                  sql_content = file.read_text()
                  cursor.execute(sql_content)

              print("✅ Deployment completed successfully!")

          finally:
              cursor.close()
              conn.close()
          EOF
